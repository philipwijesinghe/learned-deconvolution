
# Learned deconvolution using physics priors

This repository contains code for learned deconvolution using physics priors for structured light-sheet microscopy.

This work was first presented in:
*Wijesinghe P., Corsetti S., Chow D.J.X., Sakata S., Dunning K.R., Dholakia K.* 
**Learned deconvolution using physics priors for structured light-sheet microscopy** 
(PREPRINT) 2021



## Description

This code (PyTorch) trains a deep convolutional neural network (based on GANs) that is able to perform deconvolution and super-resolution of microscopy data that is encoded by structured light fields (i.e., a structured point-spread function), such as the Airy and Bessel beams.
The network uses simulated paired images based on the known physics of light propagation.
It further uses unpaired real images for saliency.

This code is separated into several functionalities.
- Simulation of paired images using the principles of image formation in light-sheet microscopy (LSM)
- Network training using simulated and real LSM data
- Inference of image sequences



### Acknowledgements

We acknowledge Erik Linder-Noren's [implementations of GANs in PyTorch](https://github.com/eriklindernoren/PyTorch-GAN) that instantiated the code developed in this project.




## Workflow


### Simulate image pairs

To create simulated physics image pairs, the user creates a folder containing a ```PhysicsDataConfig.yml``` configuration file which lists all parameters and instructions to generate the data.
Data is generated by running ```prepare_physics_data.py``` with the folder path as the parameter.


### Train network

To train the network, the user creates a folder containing a ```TrainConfig.yml``` configuration file which lists all training parameters. 
The configuration file must also include at least one path to simulated image pairs and at least one path to a folder containing real microscopy images. 
Real images must be 64x64 pixel PNG images.
Network training is initialised using ```train_physics_model.py```, and will populate the folder with training images to visualise training progress, and will perodically save the model in the ```/saved_model``` subfolder.


### Inference

Widefield microscopy images can be processed using a trained network.
Widefield images can be a sequence of PNG images of any size.
This is done by running ```process_trained_batch.py``` with the directories of the widefield image sequence and also the associated path to the trained network ```/saved_model``` subfolder.



## Folder listings

```beams\```

Code to generate Gaussian, Airy and Bessel beam shapes


```config_templates\```

Templates of configuration files used for image pair simulation and network training


```deeplearn\```

Code to perform deep learning using PyTorch


```fileio\```

Supporting functions for reading and writing files


```lsm\```

Code to simulate LSM images and PSFs






## Environment (Deep Learning)

Deep learning uses **PyTorch**.
For instance, we use a fresh Anacoda (python 3.9) environment (called 'DD' for Deep Deconvolution)

```
conda create --name DD python=3.9
```
```
conda activate DD
```

PyTorch makes use of NVidia GPUs via the CUDA Toolkit [https://developer.nvidia.com/cuda-toolkit](https://developer.nvidia.com/cuda-toolkit), which must be installed is a GPU is to be used for training.


PyTorch can be installed following the instructions on [https://pytorch.org/get-started/locally/](https://pytorch.org/get-started/locally/).

For example by running:
```
conda install pytorch torchvision torchaudio cudatoolkit=11.1 -c pytorch -c conda-forge
```

We make use of additional libraries:

```
conda install matplotlib scipy pyyaml
```

This should provide the necessary environment for PyTorch with CUDA

GPU Test should return ```true``` if using a compatible graphics card

```python
import torch
torch.cuda.is_available()
```
